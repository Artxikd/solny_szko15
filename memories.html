<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>Наши воспоминания</title>

<style>
* { box-sizing: border-box; }

body {
    margin:0;
    font-family: Arial, sans-serif;
    background:linear-gradient(180deg,#0a1f3f,#1e3d7b,#4fa3ff);
    color:white;
    text-align:center;
    overflow-x:hidden;
    min-height:100dvh;
    -webkit-overflow-scrolling: touch;
}

header { padding:2rem 0; }
header h1 { margin:0; font-size:2.5rem; }

.gallery {
    display:grid;
    grid-template-columns:repeat(auto-fill,minmax(120px,1fr));
    gap:10px;
    max-width:1000px;
    margin:10px auto;
    padding:0 6px;
}

.gallery-item {
    background:rgba(255,255,255,0.15);
    border-radius:12px;
    overflow:hidden;
    cursor:pointer;
    opacity:0;
    transform:translateY(20px);
    transition:.4s ease;
    will-change:transform,opacity;
}

.gallery-item.visible {
    opacity:1;
    transform:translateY(0);
}

.gallery-item img,
.gallery-item video {
    width:100%;
    height:100%;
    object-fit:cover;
    display:block;
}

.modal {
    display:none;
    position:fixed;
    inset:0;
    background:rgba(0,0,0,.95);
    z-index:1000;
    justify-content:center;
    align-items:center;
}

.modal-content {
    max-width:92%;
    max-height:82%;
    border-radius:18px;           /* ← скругление */
    overflow:hidden;              /* ← КРИТИЧНО */
    background:#000;
}

.modal-content img,
.modal-content video {
    width:100%;
    height:100%;
    object-fit:contain;
}

.nav-btn {
    position:absolute;
    top:50%;
    transform:translateY(-50%);
    font-size:2.2rem;
    background:rgba(0,0,0,.3);
    color:white;
    border:none;
    padding:8px 12px;
    border-radius:10px;
    z-index:10;
}

#prevBtn { left:8px; }
#nextBtn { right:8px; }

.modal-close {
    position:absolute;
    top:14px;
    right:16px;
    font-size:1.8rem;
    cursor:pointer;
}

.back-btn {
    display:inline-block;
    margin:10px 0;
    padding:8px 14px;
    border-radius:12px;
    border:2px solid rgba(255,255,255,.3);
    color:white;
    text-decoration:none;
}
</style>
</head>

<body>

<header><h1>Наши воспоминания</h1></header>
<a href="index.html" class="back-btn">← Главная</a>

<h2>Фото</h2>
<div class="gallery" id="photoGallery"></div>

<h2>Видео</h2>
<div class="gallery" id="videoGallery"></div>

<div class="modal" id="modal">
    <span class="modal-close" id="modalClose">&times;</span>
    <button class="nav-btn" id="prevBtn">&#10094;</button>
    <div class="modal-content" id="modalContent"></div>
    <button class="nav-btn" id="nextBtn">&#10095;</button>
</div>

<script>
let photos=[], videos=[], index=0, type='photo';

const photoGallery = document.getElementById('photoGallery');
const videoGallery = document.getElementById('videoGallery');
const modal = document.getElementById('modal');
const modalContent = document.getElementById('modalContent');

fetch('data/media.json')
.then(r=>r.json())
.then(data=>{
    data.forEach((item,i)=>{
        const wrap=document.createElement('div');
        wrap.className='gallery-item';

        const el=document.createElement(item.type==='image'?'img':'video');
        el.src=item.src;
        el.loading='lazy';
        el.decoding='async';

        if(item.type==='video'){
            el.poster=item.poster;          // ← ВЕРНУЛ ПРЕВЬЮ
            el.muted=true;
            el.playsInline=true;
            el.setAttribute('webkit-playsinline','');
            el.preload='metadata';          // ← КРИТИЧНО
        }

        wrap.appendChild(el);

        (item.type==='image'?photos:videos).push(item);
        (item.type==='image'?photoGallery:videoGallery).appendChild(wrap);

        setTimeout(()=>wrap.classList.add('visible'), i*40);

        wrap.onclick=()=>{
            type=item.type==='image'?'photo':'video';
            index=(type==='photo'?photos:videos).indexOf(item);
            openModal();
        };
    });
});

function openModal(){
    document.body.style.overflow='hidden';
    modal.style.display='flex';
    show();
}

function show(){
    modalContent.innerHTML='';
    const item=(type==='photo'?photos:videos)[index];

    const el=document.createElement(item.type==='image'?'img':'video');
    el.src=item.src;

    if(item.type==='video'){
        el.controls=true;
        el.muted=true;
        el.playsInline=true;
        el.setAttribute('webkit-playsinline','');
        el.poster=item.poster;
        el.preload='auto';
    }

    modalContent.appendChild(el);
}

function slide(d){
    const arr=type==='photo'?photos:videos;
    index=(index+d+arr.length)%arr.length;
    show();
}

prevBtn.onclick=()=>slide(-1);
nextBtn.onclick=()=>slide(1);

modalClose.onclick=close;
modal.onclick=e=>{if(e.target===modal) close();}

function close(){
    const v=modalContent.querySelector('video');
    if(v) v.pause();
    modal.style.display='none';
    modalContent.innerHTML='';
    document.body.style.overflow='';
}

/* свайпы iOS */
let x=0;
modalContent.addEventListener('touchstart',e=>x=e.touches[0].clientX,{passive:true});
modalContent.addEventListener('touchend',e=>{
    const dx=e.changedTouches[0].clientX-x;
    if(Math.abs(dx)>40) slide(dx>0?-1:1);
});
</script>

</body>
</html>
